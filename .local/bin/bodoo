#!/usr/bin/env bash
set -euo pipefail

SCRIPT_NAME="odoobot"

show_help() {
  cat <<EOF
Usage:
  ${SCRIPT_NAME} <version> <conf> <function> [optional args...]
  ${SCRIPT_NAME} --help

Description:
    Script for running Odoo locally via AI agents. It assumes the current working directory is an Odoo module.
  - version: sets ODOO_VERSION, i.e. '19'
  - conf: sets ODOO_CONFIG_FILE, i.e. 'test.conf'
  - function: chooses which script branch runs

Supported functions:
  server
  upgrade
  install
  tests [optional --no-coverage]
  translate

Optional args are passed into odoo-bin, unless the function specifies a separate meaning for them.
EOF
}

run_server() {
    $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin $* --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE --db-filter "^$ODOO_DATABASE$"
}
run_upgrade() {
    $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin $* --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE --db-filter "^$ODOO_DATABASE$" -u $ODOO_MODULE --stop-after-init --http-port=0
}
run_install() {
    $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin $* --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE --db-filter "^$ODOO_DATABASE$" -i $ODOO_MODULE --stop-after-init --http-port=0
}
run_tests() {
    local use_coverage=1 arg
    local -a args=()
    for arg in "$@"; do [[ "$arg" == "--no-coverage" ]] && use_coverage=0 || args+=("$arg"); done

    set -- "${args[@]}" --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE --db-filter "^$ODOO_DATABASE$" -u $ODOO_MODULE --stop-after-init --http-port=0 --test-enable --test-tags=$ODOO_MODULE

    if (( use_coverage )); then
        $ODOO_VENV/python -m coverage run --omit=__manifest__.py --source="$PWD" "$ODOO_VERSION_DIR/odoo/odoo-bin" "$@"
        $ODOO_VENV/python -m coverage report -m
    else
        $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin "$@"
    fi
}
run_translate() {
    mkdir -p i18n
    $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin i18n loadlang --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE $*
    $ODOO_VENV/python $ODOO_VERSION_DIR/odoo/odoo-bin i18n export --conf $ODOO_VERSION_DIR/$ODOO_CONFIG_FILE -d $ODOO_DATABASE $ODOO_MODULE $*
}

if [[ $# -lt 3 ]]; then
  echo "Error: missing required arguments."
  echo
  show_help
  exit 1
fi

export ODOO_VERSION="$1"
export ODOO_CONFIG_FILE="$2"
export ODOO_FUNCTION="$3"
shift 3

export ODOO_VENV="$HOME/.venv/odoo$ODOO_VERSION/bin"
export ODOO_VERSION_DIR=$HOME"/Odoo/${ODOO_VERSION}"
export ODOO_MODULE="$(basename "$PWD")"
export ODOO_DATABASE="$ODOO_VERSION-$ODOO_MODULE"

case "${ODOO_FUNCTION}" in
  server)
    run_server "$@"
    ;;
  upgrade)
    run_upgrade "$@"
    ;;
  install)
    run_install "$@"
    ;;
  tests)
    run_tests "$@"
    ;;
  translate)
    run_translate "$@"
    ;;
  --help|-h|help)
    show_help
    ;;
  *)
    echo "Error: unknown function '${ODOO_FUNCTION}'."
    echo
    show_help
    exit 1
    ;;
esac
